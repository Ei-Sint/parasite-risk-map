<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pasture & Parasite Risk Map â€” Elanco</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --bg:       #0d1117;
    --panel:    #161b22;
    --border:   #21262d;
    --border2:  #30363d;
    --text:     #e6edf3;
    --muted:    #8b949e;
    --accent:   #1f6feb;
    --green:    #3fb950;
    --amber:    #d29922;
    --red:      #f85149;
    --green-bg: rgba(63,185,80,0.12);
    --amber-bg: rgba(210,153,34,0.12);
    --red-bg:   rgba(248,81,73,0.12);
    --elanco:   #005AA0;
    --font-mono: 'Space Mono', monospace;
    --font-body: 'DM Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ TOP BAR â”€â”€ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    height: 52px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    z-index: 1000;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    width: 28px; height: 28px;
    background: var(--accent);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
  }
  .logo-text {
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.03em;
    color: var(--text);
  }
  .logo-sub {
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .season-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 4px 10px;
    border-radius: 4px;
    border: 1px solid var(--border2);
    color: var(--muted);
    text-transform: uppercase;
  }
  .live-dot {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
  }
  .live-dot::before {
    content: '';
    width: 7px; height: 7px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
  .btn-info {
    background: none;
    border: 1px solid var(--border2);
    color: var(--muted);
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--font-body);
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-info:hover {
    border-color: var(--accent);
    color: var(--text);
  }

  /* â”€â”€ MAIN LAYOUT â”€â”€ */
  .app {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar {
    width: 300px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }
  .sidebar-head {
    padding: 14px 16px 10px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-title {
    font-size: 11px;
    font-family: var(--font-mono);
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
  }
  .filter-row {
    display: flex;
    gap: 6px;
  }
  .filter-select {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border2);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-family: var(--font-body);
    outline: none;
    cursor: pointer;
  }
  .filter-select:focus { border-color: var(--accent); }

  /* legend */
  .legend-row {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
    cursor: pointer;
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid transparent;
    transition: all 0.15s;
    flex: 1;
    justify-content: center;
  }
  .legend-item.active { border-color: var(--border2); background: var(--border); color: var(--text); }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dot-green { background: var(--green); }
  .dot-amber { background: var(--amber); }
  .dot-red { background: var(--red); }

  /* farm list */
  .farm-list {
    overflow-y: auto;
    flex: 1;
  }
  .farm-list::-webkit-scrollbar { width: 4px; }
  .farm-list::-webkit-scrollbar-track { background: transparent; }
  .farm-list::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  .farm-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
    position: relative;
  }
  .farm-item:hover { background: rgba(31,111,235,0.06); }
  .farm-item.selected { background: rgba(31,111,235,0.1); }
  .farm-item.selected::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 2px;
    background: var(--accent);
  }
  .farm-risk-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .farm-item-info { flex: 1; min-width: 0; }
  .farm-item-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .farm-item-region {
    font-size: 11px;
    color: var(--muted);
    margin-top: 1px;
  }
  .farm-item-score {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 3px;
  }
  .score-low { background: var(--green-bg); color: var(--green); }
  .score-medium { background: var(--amber-bg); color: var(--amber); }
  .score-high { background: var(--red-bg); color: var(--red); }

  .loading-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 11px;
    color: var(--muted);
    font-family: var(--font-mono);
    border-bottom: 1px solid var(--border);
  }
  .spinner {
    width: 12px; height: 12px;
    border: 2px solid var(--border2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ MAP â”€â”€ */
  #map {
    flex: 1;
    position: relative;
  }

  /* â”€â”€ DETAIL PANEL â”€â”€ */
  .detail-panel {
    width: 320px;
    background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
    transition: width 0.2s;
  }
  .detail-panel.hidden { width: 0; border: none; }

  .detail-head {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
  }
  .detail-farm-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }
  .detail-region {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .close-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 16px;
    padding: 2px 4px;
    flex-shrink: 0;
    transition: color 0.15s;
  }
  .close-btn:hover { color: var(--text); }

  .detail-body {
    overflow-y: auto;
    flex: 1;
    padding: 14px 16px;
  }
  .detail-body::-webkit-scrollbar { width: 4px; }
  .detail-body::-webkit-scrollbar-thumb { background: var(--border2); }

  /* risk banner */
  .risk-banner {
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 14px;
    border: 1px solid transparent;
  }
  .risk-banner.low { background: var(--green-bg); border-color: rgba(63,185,80,0.25); }
  .risk-banner.medium { background: var(--amber-bg); border-color: rgba(210,153,34,0.25); }
  .risk-banner.high { background: var(--red-bg); border-color: rgba(248,81,73,0.25); }

  .risk-level-label {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .low .risk-level-label { color: var(--green); }
  .medium .risk-level-label { color: var(--amber); }
  .high .risk-level-label { color: var(--red); }

  .risk-level-text {
    font-size: 22px;
    font-weight: 700;
    font-family: var(--font-mono);
  }
  .low .risk-level-text { color: var(--green); }
  .medium .risk-level-text { color: var(--amber); }
  .high .risk-level-text { color: var(--red); }

  .risk-explanation {
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
    line-height: 1.55;
  }

  /* score breakdown */
  .section-label {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
    margin-top: 14px;
  }

  .score-bars { display: flex; flex-direction: column; gap: 7px; }
  .score-bar-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .score-bar-label {
    font-size: 11px;
    color: var(--muted);
    width: 90px;
    flex-shrink: 0;
  }
  .score-bar-track {
    flex: 1;
    height: 5px;
    background: var(--border2);
    border-radius: 3px;
    overflow: hidden;
  }
  .score-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease;
  }
  .score-bar-val {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--muted);
    width: 30px;
    text-align: right;
    flex-shrink: 0;
  }

  /* weather grid */
  .weather-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .weather-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 10px 12px;
  }
  .weather-card-label {
    font-size: 10px;
    color: var(--muted);
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 4px;
  }
  .weather-card-val {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    font-family: var(--font-mono);
  }
  .weather-card-unit {
    font-size: 11px;
    color: var(--muted);
    margin-left: 2px;
  }

  .timestamp {
    font-size: 10px;
    color: var(--muted);
    font-family: var(--font-mono);
    margin-top: 14px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  /* â”€â”€ ASSUMPTIONS MODAL â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--panel);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 28px;
    max-width: 520px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal h2 {
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: var(--text);
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }
  .modal-section { margin-bottom: 18px; }
  .modal-section h3 {
    font-size: 11px;
    font-family: var(--font-mono);
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 8px;
  }
  .modal-section p {
    font-size: 12.5px;
    color: var(--muted);
    line-height: 1.6;
  }
  .rule-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .rule-table th {
    font-size: 10px;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    text-align: left;
    padding: 5px 8px;
    border-bottom: 1px solid var(--border);
  }
  .rule-table td {
    font-size: 11.5px;
    color: var(--text);
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
  }
  .rule-table tr:last-child td { border: none; }
  .modal-close {
    display: block;
    margin-top: 20px;
    width: 100%;
    padding: 10px;
    background: var(--border);
    border: 1px solid var(--border2);
    color: var(--text);
    border-radius: 6px;
    font-size: 13px;
    font-family: var(--font-body);
    cursor: pointer;
    transition: background 0.15s;
  }
  .modal-close:hover { background: var(--border2); }

  /* â”€â”€ MAP CUSTOM MARKERS â”€â”€ */
  .custom-marker {
    width: 28px;
    height: 28px;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    border: 2px solid rgba(255,255,255,0.15);
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
  }
  .custom-marker:hover {
    transform: rotate(-45deg) scale(1.2);
    box-shadow: 0 4px 14px rgba(0,0,0,0.6);
  }
  .cm-inner {
    width: 100%;
    height: 100%;
    border-radius: 50% 50% 50% 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Leaflet popup override */
  .leaflet-popup-content-wrapper {
    background: var(--panel) !important;
    border: 1px solid var(--border2) !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6) !important;
    color: var(--text) !important;
    padding: 0 !important;
  }
  .leaflet-popup-content {
    margin: 0 !important;
    padding: 14px !important;
    min-width: 200px !important;
    font-family: var(--font-body) !important;
  }
  .leaflet-popup-tip { background: var(--panel) !important; }
  .leaflet-popup-close-button { color: var(--muted) !important; top: 8px !important; right: 8px !important; }

  .popup-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
  .popup-region { font-size: 11px; color: var(--muted); margin-bottom: 10px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.05em; }
  .popup-risk {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    font-weight: 700;
    font-family: var(--font-mono);
    padding: 4px 10px;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  .popup-loading { font-size: 12px; color: var(--muted); font-family: var(--font-mono); }
  .popup-detail-btn {
    display: block;
    width: 100%;
    margin-top: 8px;
    padding: 7px;
    background: rgba(31,111,235,0.15);
    border: 1px solid rgba(31,111,235,0.3);
    color: #58a6ff;
    border-radius: 5px;
    font-size: 12px;
    font-family: var(--font-body);
    cursor: pointer;
    text-align: center;
    transition: background 0.15s;
  }
  .popup-detail-btn:hover { background: rgba(31,111,235,0.25); }

  /* Leaflet tile attribution dark */
  .leaflet-control-attribution {
    background: rgba(13,17,23,0.8) !important;
    color: var(--muted) !important;
    font-size: 9px !important;
  }
  .leaflet-control-attribution a { color: var(--muted) !important; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">ğŸŒ¿</div>
    <div>
      <div class="logo-text">Pasture & Parasite Risk Map</div>
      <div class="logo-sub">Elanco Animal Health â€” UK Prototype</div>
    </div>
  </div>
  <div class="header-right">
    <div class="season-badge" id="seasonBadge">Loading...</div>
    <div class="live-dot" id="liveStatus">Fetching weather</div>
    <button class="btn-info" onclick="openModal()">Assumptions & Limitations</button>
  </div>
</header>

<!-- APP -->
<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-head">
      <div class="sidebar-title">Farm Locations</div>
      <div class="filter-row">
        <select class="filter-select" id="regionFilter" onchange="filterFarms()">
          <option value="all">All Regions</option>
          <option value="England - North">England â€“ North</option>
          <option value="England - Midlands">England â€“ Midlands</option>
          <option value="England - South">England â€“ South</option>
          <option value="Scotland">Scotland</option>
          <option value="Wales">Wales</option>
        </select>
      </div>
    </div>
    <div class="legend-row">
      <div class="legend-item active" onclick="filterRisk('all',this)"><span class="legend-dot" style="background:var(--muted)"></span>ALL</div>
      <div class="legend-item" onclick="filterRisk('Low',this)"><span class="legend-dot dot-green"></span>LOW</div>
      <div class="legend-item" onclick="filterRisk('Medium',this)"><span class="legend-dot dot-amber"></span>MED</div>
      <div class="legend-item" onclick="filterRisk('High',this)"><span class="legend-dot dot-red"></span>HIGH</div>
    </div>
    <div class="farm-list" id="farmList">
      <div class="loading-row"><div class="spinner"></div>Loading farms...</div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- DETAIL PANEL -->
  <div class="detail-panel hidden" id="detailPanel">
    <div class="detail-head">
      <div>
        <div class="detail-farm-name" id="detailName">â€”</div>
        <div class="detail-region" id="detailRegion">â€”</div>
      </div>
      <button class="close-btn" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="detail-body" id="detailBody">
      <!-- filled by JS -->
    </div>
  </div>
</div>

<!-- ASSUMPTIONS MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>âš  Assumptions &amp; Limitations</h2>
    <div class="modal-section">
      <h3>What this tool does</h3>
      <p>This prototype visualises <strong>indicative parasite risk levels</strong> for UK farm and pasture locations based on current environmental conditions. It is a proof-of-technology â€” not a diagnostic or veterinary tool.</p>
    </div>
    <div class="modal-section">
      <h3>Risk Scoring Rules</h3>
      <p>Each farm receives a risk score (0â€“10) calculated from four factors:</p>
      <table class="rule-table">
        <tr><th>Factor</th><th>Rule</th><th>Max Points</th></tr>
        <tr><td>Temperature</td><td>â‰¥10Â°C = +1, â‰¥15Â°C = +2, â‰¥20Â°C = +3</td><td>3</td></tr>
        <tr><td>Rainfall (7-day)</td><td>â‰¥5mm = +1, â‰¥15mm = +2, â‰¥30mm = +3</td><td>3</td></tr>
        <tr><td>Humidity</td><td>â‰¥60% = +1, â‰¥75% = +2</td><td>2</td></tr>
        <tr><td>Season</td><td>Spring/Autumn = +2, Summer = +1, Winter = 0</td><td>2</td></tr>
        <tr><td colspan="2"><strong>Total â†’ LOW (0â€“3), MEDIUM (4â€“6), HIGH (7â€“10)</strong></td><td>10</td></tr>
      </table>
    </div>
    <div class="modal-section">
      <h3>Data Source</h3>
      <p>Weather data is fetched in real time from <strong>Open-Meteo</strong> (open-meteo.com) â€” a free, open-source weather API. Data is refreshed each time the page loads.</p>
    </div>
    <div class="modal-section">
      <h3>Limitations</h3>
      <p>â€¢ Risk scores are based on simplified rules and should not replace veterinary advice.<br>
         â€¢ Farm locations are representative examples, not a complete database.<br>
         â€¢ Rainfall shown is the total for the past 7 days from the nearest weather station.<br>
         â€¢ Parasite risk is also influenced by soil type, stocking density, and treatment history â€” none of which are currently modelled.<br>
         â€¢ This tool has not been validated against real parasite burden data.</p>
    </div>
    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
// â”€â”€ FARM DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FARMS = [
  { id:1,  name:"Thornfield Farm",      region:"England - North",     type:"Sheep",  lat:54.2069, lng:-1.8014 },
  { id:2,  name:"Dales View Farm",      region:"England - North",     type:"Cattle", lat:54.0853, lng:-2.2920 },
  { id:3,  name:"Moorside Pastures",    region:"England - North",     type:"Mixed",  lat:53.6450, lng:-1.7830 },
  { id:4,  name:"Riverside Farm",       region:"England - Midlands",  type:"Sheep",  lat:52.9540, lng:-1.1480 },
  { id:5,  name:"Stonebridge Holdings", region:"England - Midlands",  type:"Cattle", lat:52.4060, lng:-1.5140 },
  { id:6,  name:"Greenacres Farm",      region:"England - Midlands",  type:"Sheep",  lat:52.1960, lng:-2.2200 },
  { id:7,  name:"Chalk Hill Farm",      region:"England - South",     type:"Mixed",  lat:51.2802, lng:-1.0870 },
  { id:8,  name:"Westfield Pastures",   region:"England - South",     type:"Sheep",  lat:51.0580, lng:-2.8770 },
  { id:9,  name:"Downland Farm",        region:"England - South",     type:"Cattle", lat:50.8503, lng:-0.1270 },
  { id:10, name:"Glen Carron Farm",     region:"Scotland",            type:"Sheep",  lat:57.5050, lng:-5.1800 },
  { id:11, name:"Forth Valley Pastures",region:"Scotland",            type:"Mixed",  lat:56.1370, lng:-3.9180 },
  { id:12, name:"Cambrian Hill Farm",   region:"Wales",               type:"Sheep",  lat:52.5780, lng:-3.6510 },
  { id:13, name:"Brecon Edge Farm",     region:"Wales",               type:"Cattle", lat:51.9480, lng:-3.4090 },
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let farmData = {};          // id â†’ { weather, risk, explanation, scores }
let markers  = {};          // id â†’ leaflet marker
let selectedFarm = null;
let currentRiskFilter   = 'all';
let currentRegionFilter = 'all';
let loadedCount = 0;

// â”€â”€ SEASON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSeason(month) {
  if ([3,4,5].includes(month))  return { name:"Spring", emoji:"ğŸŒ±", points:2 };
  if ([6,7,8].includes(month))  return { name:"Summer", emoji:"â˜€ï¸", points:1 };
  if ([9,10,11].includes(month))return { name:"Autumn", emoji:"ğŸ‚", points:2 };
  return { name:"Winter", emoji:"â„ï¸", points:0 };
}
const NOW    = new Date();
const SEASON = getSeason(NOW.getMonth()+1);
document.getElementById('seasonBadge').textContent = `${SEASON.emoji} ${SEASON.name}`;

// â”€â”€ RISK ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcRisk(temp, rain7d, humidity) {
  let tempPts = 0, rainPts = 0, humPts = 0;
  if (temp >= 20) tempPts = 3;
  else if (temp >= 15) tempPts = 2;
  else if (temp >= 10) tempPts = 1;

  if (rain7d >= 30) rainPts = 3;
  else if (rain7d >= 15) rainPts = 2;
  else if (rain7d >= 5)  rainPts = 1;

  if (humidity >= 75) humPts = 2;
  else if (humidity >= 60) humPts = 1;

  const seasonPts = SEASON.points;
  const total = tempPts + rainPts + humPts + seasonPts;
  let level = total <= 3 ? 'Low' : total <= 6 ? 'Medium' : 'High';

  return {
    total, level,
    scores: { temp: tempPts, rain: rainPts, humidity: humPts, season: seasonPts }
  };
}

function buildExplanation(farm, temp, rain7d, humidity, risk) {
  const levelVerbs = { Low: 'low', Medium: 'moderate', High: 'high' };
  let factors = [];
  if (risk.scores.temp >= 2)     factors.push(`warm temperatures (${temp.toFixed(1)}Â°C)`);
  if (risk.scores.rain >= 2)     factors.push(`high recent rainfall (${rain7d.toFixed(1)}mm over 7 days)`);
  if (risk.scores.humidity >= 1) factors.push(`elevated humidity (${humidity.toFixed(0)}%)`);
  if (risk.scores.season === 2)  factors.push(`${SEASON.name.toLowerCase()} season (peak larval activity)`);

  if (risk.level === 'Low') {
    return `Conditions at ${farm.name} are currently unfavourable for parasite larvae. Temperature (${temp.toFixed(1)}Â°C), rainfall (${rain7d.toFixed(1)}mm) and humidity (${humidity.toFixed(0)}%) are below risk thresholds.`;
  }
  if (factors.length === 0) {
    return `A combination of borderline weather conditions results in ${levelVerbs[risk.level]} overall parasite risk at this location.`;
  }
  return `Risk is ${risk.level.toUpperCase()} due to ${factors.slice(0,-1).join(', ')}${factors.length > 1 ? ' and ' : ''}${factors[factors.length-1]}. These conditions favour parasite larval survival on pasture.`;
}

// â”€â”€ MAP SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { center: [54.5, -3.5], zoom: 6, zoomControl: true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://carto.com/">CARTO</a> &copy; OpenStreetMap',
  subdomains: 'abcd', maxZoom: 18
}).addTo(map);

// â”€â”€ MARKER ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function riskColor(level) {
  return { Low:'#3fb950', Medium:'#d29922', High:'#f85149' }[level] || '#8b949e';
}

function makeIcon(level) {
  const c = riskColor(level);
  const svg = `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
    <path d="M16 2C9.37 2 4 7.37 4 14c0 9 12 24 12 24s12-15 12-24C28 7.37 22.63 2 16 2z"
      fill="${c}" fill-opacity="0.9" stroke="rgba(255,255,255,0.2)" stroke-width="1.5"/>
    <circle cx="16" cy="14" r="5" fill="rgba(0,0,0,0.25)"/>
    <circle cx="16" cy="14" r="3.5" fill="rgba(255,255,255,0.85)"/>
  </svg>`;
  return L.divIcon({
    html: svg,
    className: '',
    iconSize: [32, 40],
    iconAnchor: [16, 40],
    popupAnchor: [0, -42]
  });
}

function makeLoadingIcon() {
  const svg = `<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg">
    <path d="M16 2C9.37 2 4 7.37 4 14c0 9 12 24 12 24s12-15 12-24C28 7.37 22.63 2 16 2z"
      fill="#8b949e" fill-opacity="0.5" stroke="rgba(255,255,255,0.1)" stroke-width="1.5"/>
    <circle cx="16" cy="14" r="5" fill="rgba(0,0,0,0.15)"/>
    <circle cx="16" cy="14" r="3.5" fill="rgba(255,255,255,0.4)"/>
  </svg>`;
  return L.divIcon({ html: svg, className:'', iconSize:[32,40], iconAnchor:[16,40], popupAnchor:[0,-42] });
}

// â”€â”€ PLACE MARKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FARMS.forEach(farm => {
  const m = L.marker([farm.lat, farm.lng], { icon: makeLoadingIcon() }).addTo(map);
  m.bindPopup(buildLoadingPopup(farm));
  m.on('click', () => {
    selectedFarm = farm.id;
    highlightListItem(farm.id);
    if (farmData[farm.id]) openDetail(farm.id);
  });
  markers[farm.id] = m;
});

function buildLoadingPopup(farm) {
  return `<div class="popup-name">${farm.name}</div>
    <div class="popup-region">${farm.region} Â· ${farm.type}</div>
    <div class="popup-loading">â³ Fetching weather data...</div>`;
}

function buildPopupHTML(farm, d) {
  const c = riskColor(d.risk.level);
  return `<div class="popup-name">${farm.name}</div>
    <div class="popup-region">${farm.region} Â· ${farm.type}</div>
    <div class="popup-risk" style="background:${c}22;color:${c};border:1px solid ${c}44">
      â— ${d.risk.level.toUpperCase()} RISK
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">
      ğŸŒ¡ ${d.temp.toFixed(1)}Â°C &nbsp;|&nbsp; ğŸŒ§ ${d.rain7d.toFixed(1)}mm &nbsp;|&nbsp; ğŸ’§ ${d.humidity.toFixed(0)}%
    </div>
    <button class="popup-detail-btn" onclick="openDetailById(${farm.id})">View full details â†’</button>`;
}

// â”€â”€ WEATHER FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchFarmWeather(farm) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${farm.lat}&longitude=${farm.lng}`+
    `&current=temperature_2m,relative_humidity_2m`+
    `&daily=precipitation_sum&past_days=7&forecast_days=1&timezone=Europe%2FLondon`;
  const res  = await fetch(url);
  const json = await res.json();
  const temp     = json.current.temperature_2m;
  const humidity = json.current.relative_humidity_2m;
  const rain7d   = json.daily.precipitation_sum.slice(0,-1).reduce((a,b)=>a+(b||0), 0);
  return { temp, humidity, rain7d };
}

async function loadAllFarms() {
  // batch in groups of 3 to avoid hammering the API
  for (let i = 0; i < FARMS.length; i += 3) {
    const batch = FARMS.slice(i, i+3);
    await Promise.all(batch.map(async farm => {
      try {
        const w = await fetchFarmWeather(farm);
        const risk = calcRisk(w.temp, w.rain7d, w.humidity);
        const explanation = buildExplanation(farm, w.temp, w.rain7d, w.humidity, risk);
        farmData[farm.id] = { ...w, risk, explanation, fetchedAt: new Date() };
        markers[farm.id].setIcon(makeIcon(risk.level));
        markers[farm.id].setPopupContent(buildPopupHTML(farm, farmData[farm.id]));
        loadedCount++;
        renderFarmList();
        if (selectedFarm === farm.id) openDetail(farm.id);
      } catch(e) {
        console.warn(`Failed to fetch ${farm.name}`, e);
        farmData[farm.id] = null;
        loadedCount++;
        renderFarmList();
      }
    }));
  }
  const loaded = Object.values(farmData).filter(Boolean).length;
  document.getElementById('liveStatus').textContent =
    `Live data Â· ${loaded}/${FARMS.length} farms`;
}

// â”€â”€ SIDEBAR FARM LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getVisibleFarms() {
  return FARMS.filter(f => {
    if (currentRegionFilter !== 'all' && f.region !== currentRegionFilter) return false;
    const d = farmData[f.id];
    if (!d) return currentRiskFilter === 'all';
    if (currentRiskFilter !== 'all' && d.risk.level !== currentRiskFilter) return false;
    return true;
  });
}

function renderFarmList() {
  const list = document.getElementById('farmList');
  const visible = getVisibleFarms();
  if (visible.length === 0) {
    list.innerHTML = `<div class="loading-row" style="color:var(--muted)">No farms match this filter.</div>`;
    return;
  }
  list.innerHTML = visible.map(farm => {
    const d = farmData[farm.id];
    const riskLabel = d ? d.risk.level : 'â€¦';
    const riskClass = d ? `score-${d.risk.level.toLowerCase()}` : '';
    const dotColor  = d ? riskColor(d.risk.level) : '#8b949e';
    const isSelected = selectedFarm === farm.id;
    return `<div class="farm-item${isSelected?' selected':''}" onclick="selectFarm(${farm.id})">
      <div class="farm-risk-dot" style="background:${dotColor}"></div>
      <div class="farm-item-info">
        <div class="farm-item-name">${farm.name}</div>
        <div class="farm-item-region">${farm.region}</div>
      </div>
      <div class="farm-item-score ${riskClass}">${d ? riskLabel : '...'}</div>
    </div>`;
  }).join('');

  // update marker visibility
  FARMS.forEach(farm => {
    const m = markers[farm.id];
    const show = visible.find(f => f.id === farm.id);
    if (show) { if (!map.hasLayer(m)) m.addTo(map); }
    else       { if (map.hasLayer(m)) map.removeLayer(m); }
  });
}

function filterFarms() {
  currentRegionFilter = document.getElementById('regionFilter').value;
  renderFarmList();
}

function filterRisk(level, el) {
  currentRiskFilter = level;
  document.querySelectorAll('.legend-item').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  renderFarmList();
}

function selectFarm(id) {
  selectedFarm = id;
  renderFarmList();
  const farm = FARMS.find(f => f.id === id);
  map.flyTo([farm.lat, farm.lng], 10, { duration: 0.8 });
  markers[id].openPopup();
  if (farmData[id]) openDetail(id);
}

function highlightListItem(id) {
  selectedFarm = id;
  renderFarmList();
}

// â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetailById(id) {
  selectedFarm = id;
  renderFarmList();
  openDetail(id);
}

function openDetail(id) {
  const farm = FARMS.find(f => f.id === id);
  const d    = farmData[id];
  if (!d) return;

  document.getElementById('detailName').textContent   = farm.name;
  document.getElementById('detailRegion').textContent = `${farm.region} Â· ${farm.type}`;
  document.getElementById('detailPanel').classList.remove('hidden');

  const lvl = d.risk.level.toLowerCase();
  const maxScore = 10;
  const pct = v => Math.round((v / 3) * 100);
  const barColor = { Low: '#3fb950', Medium: '#d29922', High: '#f85149' }[d.risk.level];

  document.getElementById('detailBody').innerHTML = `
    <div class="risk-banner ${lvl}">
      <div class="risk-level-label">Parasite Risk Level</div>
      <div class="risk-level-text">${d.risk.level.toUpperCase()}</div>
      <div class="risk-explanation">${d.explanation}</div>
    </div>

    <div class="section-label">Score Breakdown (${d.risk.total} / 10)</div>
    <div class="score-bars">
      <div class="score-bar-row">
        <div class="score-bar-label">Temperature</div>
        <div class="score-bar-track"><div class="score-bar-fill" style="width:${pct(d.risk.scores.temp)}%;background:${barColor}"></div></div>
        <div class="score-bar-val">${d.risk.scores.temp}/3</div>
      </div>
      <div class="score-bar-row">
        <div class="score-bar-label">Rainfall (7d)</div>
        <div class="score-bar-track"><div class="score-bar-fill" style="width:${pct(d.risk.scores.rain)}%;background:${barColor}"></div></div>
        <div class="score-bar-val">${d.risk.scores.rain}/3</div>
      </div>
      <div class="score-bar-row">
        <div class="score-bar-label">Humidity</div>
        <div class="score-bar-track"><div class="score-bar-fill" style="width:${(d.risk.scores.humidity/2)*100}%;background:${barColor}"></div></div>
        <div class="score-bar-val">${d.risk.scores.humidity}/2</div>
      </div>
      <div class="score-bar-row">
        <div class="score-bar-label">Season</div>
        <div class="score-bar-track"><div class="score-bar-fill" style="width:${(d.risk.scores.season/2)*100}%;background:${barColor}"></div></div>
        <div class="score-bar-val">${d.risk.scores.season}/2</div>
      </div>
    </div>

    <div class="section-label">Current Weather</div>
    <div class="weather-grid">
      <div class="weather-card">
        <div class="weather-card-label">Temperature</div>
        <div class="weather-card-val">${d.temp.toFixed(1)}<span class="weather-card-unit">Â°C</span></div>
      </div>
      <div class="weather-card">
        <div class="weather-card-label">Humidity</div>
        <div class="weather-card-val">${d.humidity.toFixed(0)}<span class="weather-card-unit">%</span></div>
      </div>
      <div class="weather-card">
        <div class="weather-card-label">7-day Rainfall</div>
        <div class="weather-card-val">${d.rain7d.toFixed(1)}<span class="weather-card-unit">mm</span></div>
      </div>
      <div class="weather-card">
        <div class="weather-card-label">Season</div>
        <div class="weather-card-val" style="font-size:14px">${SEASON.emoji} ${SEASON.name}</div>
      </div>
    </div>

    <div class="timestamp">
      Data fetched: ${d.fetchedAt.toLocaleString('en-GB')}<br>
      Source: Open-Meteo (open-meteo.com) Â· Rule-based scoring v1.0
    </div>`;
}

function closeDetail() {
  document.getElementById('detailPanel').classList.add('hidden');
  selectedFarm = null;
  renderFarmList();
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal() { document.getElementById('modal').classList.add('open'); }
function closeModal() { document.getElementById('modal').classList.remove('open'); }
document.getElementById('modal').addEventListener('click', e => {
  if (e.target === document.getElementById('modal')) closeModal();
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderFarmList();
loadAllFarms();
</script>
</body>
</html>
